---
description: Advanced Python best practices for ML/AI applications (2025)
globs: ["**/*.py"]
alwaysApply: true
---

# ğŸ Senior Python Developer Best Practices for ML/AI (2025)

## ğŸ“¦ Package Management & Dependencies

### Modern Tools (What Seniors Use)
- **âœ… `uv`**: Ultra-fast Python package installer (Rust-based, replaces pip/pip-tools)
- **âœ… `pyproject.toml`**: Single source of truth for project metadata (replaces setup.py, requirements.txt)
- **âœ… Virtual environments**: Always use `.venv`, never install globally
- **âœ… Lock files**: `uv.lock` pins exact versions for reproducibility

### What Juniors Might Miss
- âŒ Using `pip install` directly without lock files
- âŒ Mixing `requirements.txt` with `pyproject.toml`
- âŒ Not specifying version constraints (`package>=1.0.0,<2.0.0`)
- âŒ Installing packages globally instead of in virtual environments

### Best Practices
```bash
# âœ… Modern way
uv init                    # Initialize project
uv add package-name        # Add dependency
uv sync                    # Install/sync dependencies
uv run python script.py    # Run in virtual environment

# âŒ Old way
pip install package-name   # No lock file, no version tracking
```

---

## ğŸ¯ Type Hints & Static Analysis

### What Seniors Use
- **âœ… Type hints everywhere**: `def process(data: List[str]) -> Dict[str, int]:`
- **âœ… `mypy`**: Static type checker to catch errors before runtime
- **âœ… `pyright`**: Microsoft's fast type checker (used by VS Code)
- **âœ… Pydantic**: Runtime validation + type hints = bulletproof code

### Type Hint Patterns
```python
# âœ… Good: Specific types
from typing import List, Dict, Optional, Union
def process_chunks(chunks: List[TextChunk]) -> List[SearchResult]:
    ...

# âŒ Bad: Too generic
def process_chunks(chunks: List[Any]) -> List[Dict[str, Any]]:
    ...

# âœ… Good: Optional for nullable values
def get_user(user_id: str) -> Optional[User]:
    ...

# âœ… Good: Type aliases for complex types
UserId = str
UserDict = Dict[str, Union[str, int, bool]]
```

### Setup mypy
```toml
# pyproject.toml
[tool.mypy]
python_version = "3.11"
strict = true
warn_return_any = true
warn_unused_configs = true
disallow_untyped_defs = true
```

---

## ğŸ—ï¸ Code Organization & Architecture

### What Seniors Do
- **âœ… Separation of Concerns**: Routes, services, models, utils are separate
- **âœ… Dependency Injection**: Pass dependencies, don't create them
- **âœ… Single Responsibility**: Each class/function does ONE thing
- **âœ… `__all__`**: Explicit public API in `__init__.py`

### Folder Structure (FastAPI + ML)
```
project/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.py                 # FastAPI app entry
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ config.py          # Pydantic Settings
â”‚   â”‚   â”œâ”€â”€ exceptions.py      # Custom exceptions
â”‚   â”‚   â””â”€â”€ results.py         # Structured results
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ schemas.py         # API schemas (Pydantic)
â”‚   â”‚   â””â”€â”€ internal.py        # Internal data models
â”‚   â”œâ”€â”€ services/              # Business logic
â”‚   â”‚   â”œâ”€â”€ pdf_processor.py
â”‚   â”‚   â”œâ”€â”€ vector_store.py
â”‚   â”‚   â””â”€â”€ answer_generator.py
â”‚   â””â”€â”€ api/
â”‚       â””â”€â”€ routes/            # API endpoints
â”œâ”€â”€ tests/                     # Unit & integration tests
â”œâ”€â”€ dev_scripts/              # Development helpers
â””â”€â”€ pyproject.toml
```

### What Juniors Miss
- âŒ Putting everything in one file
- âŒ Business logic in routes
- âŒ No clear separation between layers
- âŒ Tight coupling between components

---

## ğŸ§ª Testing & Quality

### What Seniors Use
- **âœ… `pytest`**: Modern testing framework (not unittest)
- **âœ… `pytest-asyncio`**: For async tests
- **âœ… `pytest-cov`**: Code coverage reports
- **âœ… Fixtures**: Reusable test setup
- **âœ… Mocking**: Mock external services (API calls, DB)

### Testing Patterns
```python
# âœ… Good: Clear test structure
import pytest
from app.services import PDFProcessor

@pytest.fixture
def pdf_processor():
    """Fixture provides configured processor."""
    config = PDFProcessingConfig(chunk_size=512)
    return PDFProcessor(config)

def test_chunk_text_creates_correct_number_of_chunks(pdf_processor):
    # Arrange
    text_data = [{"page": 1, "text": "Sample text"}]
    
    # Act
    chunks = pdf_processor.chunk_text(text_data, "test.pdf")
    
    # Assert
    assert len(chunks) > 0
    assert all(isinstance(c, TextChunk) for c in chunks)

# âœ… Good: Mock external services
@pytest.mark.asyncio
async def test_answer_generation_mocks_llm(mocker):
    mock_llm = mocker.patch("app.services.answer_generator.init_chat_model")
    mock_llm.return_value.ainvoke.return_value = "Mocked answer"
    
    generator = AnswerGenerator()
    context = AnswerContext(question="test", search_results=[...])
    result = await generator.generate_answer(context)
    
    assert result.answer == "Mocked answer"
```

### Running Tests
```bash
# Run all tests with coverage
uv run pytest --cov=app --cov-report=html

# Run specific test file
uv run pytest tests/test_pdf_processor.py -v

# Run tests matching pattern
uv run pytest -k "test_chunk" -v
```

---

## ğŸ¨ Code Style & Linting

### What Seniors Use
- **âœ… `ruff`**: Ultra-fast linter & formatter (replaces black, flake8, isort)
- **âœ… `pre-commit`**: Git hooks to enforce quality
- **âœ… Consistent formatting**: No debates, just auto-format

### Setup Ruff
```toml
# pyproject.toml
[tool.ruff]
line-length = 100
target-version = "py311"

[tool.ruff.lint]
select = [
    "E",   # pycodestyle errors
    "W",   # pycodestyle warnings
    "F",   # pyflakes
    "I",   # isort
    "N",   # pep8-naming
    "UP",  # pyupgrade
]
ignore = ["E501"]  # Line too long (handled by formatter)

[tool.ruff.format]
quote-style = "double"
indent-style = "space"
```

### Pre-commit hooks
```yaml
# .pre-commit-config.yaml
repos:
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.1.6
    hooks:
      - id: ruff
        args: [--fix]
      - id: ruff-format
```

---

## ğŸ“Š Logging & Monitoring

### What Seniors Use
- **âœ… `structlog`**: Structured logging (JSON output)
- **âœ… Log levels**: DEBUG, INFO, WARNING, ERROR, CRITICAL
- **âœ… Correlation IDs**: Track requests across services
- **âœ… Never use `print()`**: Use proper logging

### Logging Best Practices
```python
# âœ… Good: Structured logging
import logging
import structlog

logger = structlog.get_logger(__name__)

def process_document(doc_id: str):
    logger.info("processing_document", doc_id=doc_id, action="start")
    try:
        # ... processing ...
        logger.info("processing_document", doc_id=doc_id, action="complete", chunks=10)
    except Exception as e:
        logger.error("processing_failed", doc_id=doc_id, error=str(e))
        raise

# âŒ Bad: Print statements
def process_document(doc_id: str):
    print(f"Processing {doc_id}")  # Lost in production!
    # ... processing ...
    print("Done!")
```

### Configuration
```python
# app/core/logging.py
import structlog

def setup_logging():
    structlog.configure(
        processors=[
            structlog.stdlib.filter_by_level,
            structlog.stdlib.add_logger_name,
            structlog.stdlib.add_log_level,
            structlog.processors.TimeStamper(fmt="iso"),
            structlog.processors.StackInfoRenderer(),
            structlog.processors.format_exc_info,
            structlog.processors.JSONRenderer()
        ],
        wrapper_class=structlog.stdlib.BoundLogger,
        context_class=dict,
        logger_factory=structlog.stdlib.LoggerFactory(),
    )
```

---

## ğŸ”’ Configuration & Secrets

### What Seniors Use
- **âœ… `pydantic-settings`**: Type-safe configuration
- **âœ… Environment variables**: Never hardcode secrets
- **âœ… `.env` files**: For local development only
- **âœ… `.env.example`**: Template for required variables

### Configuration Pattern
```python
# app/core/config.py
from pydantic_settings import BaseSettings, SettingsConfigDict

class Settings(BaseSettings):
    """Application settings with validation."""
    model_config = SettingsConfigDict(
        env_file=".env",
        env_file_encoding="utf-8",
        case_sensitive=False
    )
    
    # API Keys
    openai_api_key: str
    qdrant_url: str = "http://localhost:6333"
    
    # App Settings
    app_name: str = "InsuranceLens"
    debug: bool = False
    
    # ML Settings
    embedding_model: str = "text-embedding-3-small"
    chunk_size: int = 512
    
    # Validate fields
    @property
    def is_production(self) -> bool:
        return not self.debug

settings = Settings()
```

### What Juniors Miss
- âŒ Hardcoding API keys in code
- âŒ No validation of configuration
- âŒ Committing `.env` to git
- âŒ No defaults for optional settings

---

## ğŸ¤– ML/AI Specific Best Practices

### Vector Databases
- **âœ… Qdrant/Weaviate/Pinecone**: Don't build your own
- **âœ… Batch operations**: Upsert chunks in batches
- **âœ… Metadata filtering**: Store metadata for filtering
- **âœ… Separate collections**: One per user/policy

### LLM Integration
- **âœ… LangChain**: For complex chains and agents
- **âœ… Rate limiting**: Handle API rate limits gracefully
- **âœ… Streaming**: Stream responses for better UX
- **âœ… Caching**: Cache embeddings and frequent queries
- **âœ… Token counting**: Track and limit token usage

### Prompt Engineering
```python
# âœ… Good: Structured prompts with clear instructions
SYSTEM_PROMPT = """You are an expert in German health insurance policies.

RULES:
1. Always respond in German
2. Use only provided document information
3. Cite sources with [Page X]
4. If unsure, say so clearly

FORMAT:
- Use **bold** for key terms
- Use bullet points for lists
"""

# âŒ Bad: Vague prompts
SYSTEM_PROMPT = "Answer questions about insurance."
```

### Error Handling for ML
```python
# âœ… Good: Specific exceptions
class EmbeddingGenerationError(Exception):
    """Raised when embedding generation fails."""
    pass

class VectorSearchTimeout(Exception):
    """Raised when vector search times out."""
    pass

try:
    embeddings = generate_embeddings(text)
except OpenAIError as e:
    logger.error("openai_error", error=str(e))
    raise EmbeddingGenerationError(f"Failed to generate embeddings: {e}")
```

---

## ğŸš€ Performance & Optimization

### What Seniors Do
- **âœ… Profiling**: Use `cProfile`, `line_profiler` to find bottlenecks
- **âœ… Async/await**: For I/O-bound operations (API calls, DB queries)
- **âœ… Batch processing**: Process multiple items together
- **âœ… Caching**: `functools.lru_cache` for expensive computations
- **âœ… Connection pooling**: Reuse DB/API connections

### Async Patterns
```python
# âœ… Good: Async for I/O operations
async def process_multiple_documents(docs: List[str]) -> List[ProcessedDocument]:
    tasks = [process_single_document(doc) for doc in docs]
    return await asyncio.gather(*tasks)

# âœ… Good: Connection pooling
from sqlalchemy.ext.asyncio import create_async_engine

engine = create_async_engine(
    DATABASE_URL,
    pool_size=20,
    max_overflow=10
)
```

### Caching
```python
from functools import lru_cache

@lru_cache(maxsize=1000)
def get_embedding(text: str) -> List[float]:
    """Cache embeddings to avoid re-computing."""
    return openai.embeddings.create(text).data[0].embedding
```

---

## ğŸ“š Documentation

### What Seniors Document
- **âœ… Docstrings**: All public functions/classes (Google style)
- **âœ… Type hints**: Self-documenting code
- **âœ… README**: Clear setup instructions
- **âœ… Architecture docs**: High-level system design
- **âœ… API docs**: Auto-generated with FastAPI/Swagger

### Docstring Style (Google Format)
```python
def search_similar_chunks(
    self,
    policy_id: str,
    query: str,
    limit: Optional[int] = None
) -> List[SearchResult]:
    """Search for similar chunks using vector similarity.
    
    Args:
        policy_id: Unique identifier for the policy to search
        query: Search query text
        limit: Maximum number of results to return. If None, uses
            configured default from settings.
    
    Returns:
        List of SearchResult objects ordered by relevance score,
        each containing a TextChunk and similarity score.
    
    Raises:
        CollectionNotFoundError: If policy collection doesn't exist
        VectorSearchError: If search operation fails
        
    Example:
        >>> results = store.search_similar_chunks("policy-123", "waiting period")
        >>> print(f"Found {len(results)} results")
        Found 5 results
    """
    ...
```

---

## ğŸ” Security

### What Seniors Do
- **âœ… Input validation**: Use Pydantic for all inputs
- **âœ… SQL injection prevention**: Use ORMs or parameterized queries
- **âœ… CORS properly configured**: Whitelist specific origins
- **âœ… Rate limiting**: Prevent abuse
- **âœ… Secrets scanning**: Use `detect-secrets` in pre-commit

### Security Patterns
```python
# âœ… Good: Input validation
from pydantic import BaseModel, Field, validator

class QuestionRequest(BaseModel):
    question: str = Field(..., min_length=1, max_length=500)
    
    @validator("question")
    def question_must_be_safe(cls, v):
        if any(char in v for char in ["<", ">", "script"]):
            raise ValueError("Invalid characters in question")
        return v

# âœ… Good: Rate limiting
from slowapi import Limiter, _rate_limit_exceeded_handler
from slowapi.util import get_remote_address

limiter = Limiter(key_func=get_remote_address)
app.state.limiter = limiter

@app.post("/api/policies/upload")
@limiter.limit("5/minute")
async def upload_policy(request: Request):
    ...
```

---

## ğŸ“¦ Essential Libraries for ML/AI Apps (2025)

### Core Framework
- `fastapi` - Modern web framework
- `uvicorn[standard]` - ASGI server

### Data & Validation
- `pydantic` - Data validation
- `pydantic-settings` - Configuration management

### ML/AI
- `langchain` - LLM orchestration
- `langchain-openai` - OpenAI integration
- `qdrant-client` - Vector database
- `tiktoken` - Token counting
- `openai` - OpenAI API

### Development
- `pytest` - Testing
- `pytest-asyncio` - Async testing
- `pytest-cov` - Coverage
- `mypy` - Type checking
- `ruff` - Linting & formatting
- `pre-commit` - Git hooks

### Monitoring
- `structlog` - Structured logging
- `prometheus-client` - Metrics
- `sentry-sdk` - Error tracking

### Utilities
- `python-dotenv` - Load .env files
- `httpx` - Async HTTP client
- `tenacity` - Retry logic

---

## ğŸ¯ Summary: Junior â†’ Senior Checklist

### Junior Typically Does
- âŒ Uses `pip install` without lock files
- âŒ No type hints
- âŒ Everything in one file
- âŒ Uses `print()` for debugging
- âŒ Hardcodes configuration
- âŒ No tests
- âŒ Generic exceptions
- âŒ No documentation

### Senior Always Does
- âœ… Uses `uv` with `pyproject.toml`
- âœ… Type hints + mypy + Pydantic
- âœ… Clean architecture with separation of concerns
- âœ… Structured logging with `structlog`
- âœ… Pydantic Settings for configuration
- âœ… Comprehensive tests with >80% coverage
- âœ… Custom exception hierarchy
- âœ… Google-style docstrings everywhere

---

## ğŸš€ Quick Setup for New Project

```bash
# 1. Initialize project
uv init
uv add fastapi uvicorn pydantic pydantic-settings

# 2. Add ML dependencies
uv add langchain langchain-openai qdrant-client tiktoken openai

# 3. Add development tools
uv add --dev pytest pytest-asyncio pytest-cov mypy ruff pre-commit

# 4. Setup pre-commit
uv run pre-commit install

# 5. Create .env.example
cat > .env.example << EOF
OPENAI_API_KEY=your-key-here
QDRANT_URL=http://localhost:6333
DEBUG=false
EOF

# 6. Run tests
uv run pytest --cov=app

# 7. Format code
uv run ruff format .

# 8. Type check
uv run mypy app/
```

---

## ğŸ“– Resources

- [Pydantic Documentation](https://docs.pydantic.dev/)
- [FastAPI Best Practices](https://github.com/zhanymkanov/fastapi-best-practices)
- [LangChain Documentation](https://python.langchain.com/)
- [Python Type Hints Cheat Sheet](https://mypy.readthedocs.io/en/stable/cheat_sheet_py3.html)
- [Real Python](https://realpython.com/) - High-quality tutorials
